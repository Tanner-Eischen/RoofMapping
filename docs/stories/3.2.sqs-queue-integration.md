# Story 3.2: SQS Queue Integration

## Status
Draft

## Story
**As a** backend API
**I want** to submit analysis jobs to an SQS queue
**So that** ML processing is decoupled from the web tier

## Acceptance Criteria
- [ ] AWS SQS queue created (Terraform or manual)
- [ ] Queue client module created (`lib/queue/client.ts`)
- [ ] sendMessage method implemented
- [ ] Message format defined: {analysisId, address, coordinates}
- [ ] Error handling for queue failures
- [ ] Fallback: update analysis status to "failed" if queue submission fails
- [ ] Queue URL configured via environment variable
- [ ] Dead letter queue configured (after 3 retries)

## Tasks / Subtasks
- [ ] Provision SQS and DLQ (AC: 1, 8)
- [ ] Implement `lib/queue/client.ts` (AC: 2-3)
- [ ] Define message schema and send (AC: 4)
- [ ] Add error handling and status fallback (AC: 5-6)
- [ ] Read queue URL from env (AC: 7)

## Dev Notes
- Data flow and decoupling: [../architecture/system-architecture.md#data-flow](../architecture/system-architecture.md#data-flow)
- Queue service module: [../architecture/backend-architecture.md#queue-service](../architecture/backend-architecture.md#queue-service)
- Resilience and fallbacks: [../architecture/error-handling-resilience.md#fallback-mechanisms](../architecture/error-handling-resilience.md#fallback-mechanisms)
- Metrics and monitoring: [../architecture/monitoring-observability.md#metrics-to-track](../architecture/monitoring-observability.md#metrics-to-track)
- PRD traceability: [../prd/12-epic-and-story-structure.md#story-32-sqs-queue-integration](../prd/12-epic-and-story-structure.md#story-32-sqs-queue-integration)

## Dependencies
- 3.1 Analysis submission endpoint
- 6.2 AWS infrastructure setup (SQS)
- 1.4 Environment configuration (queue URLs and IAM)

## Estimate
M (medium)

## Priority
P0 (critical for decoupled processing)

## Assumptions
- IAM roles and permissions allow sendMessage.
- Queue and DLQ are provisioned and accessible.
- Message schema kept minimal to avoid size issues.

## Edge Cases
- Throttling or AWS regional outages; implement exponential backoff.
- Message size limits exceeded; validate and truncate or reject.
- Partial failures: status fallback to "failed" is idempotent.

### Testing
- Unit: message builder and schema validation.
- Integration: successful send; DLQ routing after configured retries.
- Resilience: fallback status update on send failure.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | v1 | Initial draft created | Scrum Master |

## Dev Agent Record
- Agent Model Used: 
- Debug Log References: 
- Completion Notes List: 
- File List: 

## QA Results
- Pending