# Story 3.4: Photo Upload Endpoint

## Status
Draft

## Story
**As a** frontend application
**I want** to upload supplementary photos for enhanced analysis
**So that** obstructed roofs can still be measured accurately

## Acceptance Criteria
- [ ] API route created (`app/api/assist/upload/route.ts`)
- [ ] Accept multipart/form-data with 3 photos
- [ ] Validate file types (JPEG/PNG only)
- [ ] Validate file sizes (max 10MB each)
- [ ] Upload photos to S3 or Vercel Blob storage
- [ ] Create photo records in database
- [ ] Submit enhanced analysis job to queue
- [ ] Return 200 on success
- [ ] Error handling for upload failures

## Tasks / Subtasks
- [ ] Implement `POST /api/assist/upload` (AC: 1)
- [ ] Multipart parsing and validation (AC: 2-4)
- [ ] Upload to storage provider (AC: 5)
- [ ] Create DB records and link to analysis (AC: 6)
- [ ] Submit enhanced job to queue (AC: 7)
- [ ] Return 200; error handling (AC: 8-9)

## Dev Notes
- API route structure: [../architecture/backend-architecture.md#api-routes-architecture](../architecture/backend-architecture.md#api-routes-architecture)
- Data schema considerations: [../architecture/data-layer.md#database-schema-prisma](../architecture/data-layer.md#database-schema-prisma)
- Storage provider integration: [../architecture/external-integrations.md#aws-services](../architecture/external-integrations.md#aws-services)
- Error handling: [../architecture/error-handling-resilience.md#error-handling-strategy](../architecture/error-handling-resilience.md#error-handling-strategy)
- PRD traceability: [../prd/12-epic-and-story-structure.md#story-34-photo-upload-endpoint](../prd/12-epic-and-story-structure.md#story-34-photo-upload-endpoint)

## Dependencies
- 6.2 AWS infrastructure setup (S3 or Blob)
- 1.2 Database Setup with Prisma (photo records)
- 3.2 SQS Queue Integration (enhanced job submission)

## Estimate
M (medium)

## Priority
P1

## Assumptions
- 3 photos are required for enhanced analysis.
- File type and size limits are enforced consistently.
- Storage provider credentials configured securely.

## Edge Cases
- Invalid file types or corrupted images; reject with clear error.
- Oversized files; suggest compression or provide client-side compression.
- Partial uploads; ensure atomicity or cleanup on failure.

### Testing
- Integration: multipart parsing, validation, storage upload, DB record creation.
- Resilience: error paths for invalid files and storage failures.
- Queue: enhanced job submission path verified.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | v1 | Initial draft created | Scrum Master |

## Dev Agent Record
- Agent Model Used: 
- Debug Log References: 
- Completion Notes List: 
- File List: 

## QA Results
- Pending