# Story 4.5: Measurement Calculation Engine

## Status
Draft

## Story
**As an** ML service
**I want** to calculate roof measurements from detected polygons and LiDAR
**So that** I can provide accurate area, perimeter, pitch, and slope

## Acceptance Criteria
- [ ] Measurement calculation implemented in measurement_service.py
- [ ] Area calculation (pixels to square feet conversion)
- [ ] Perimeter calculation (pixels to feet conversion)
- [ ] Pitch calculation from LiDAR elevation data
- [ ] Slope percentage calculation
- [ ] Feature detection (vents, chimneys, etc.) - basic implementation
- [ ] Complexity score calculation (1-10 scale)
- [ ] Confidence score calculation based on multiple factors
- [ ] Accuracy validation: ±3% target
- [ ] Calculate pitch confidence score (0-100%)
- [ ] Flag low-confidence pitch when LiDAR unavailable
- [ ] Add 'Estimated' tag to pitch measurements without LiDAR

## Tasks / Subtasks
- [ ] Implement area/perimeter conversion logic (AC: 2-3)
- [ ] Pitch/slope calculation from LiDAR (AC: 4-5)
- [ ] Basic feature detection (AC: 6)
- [ ] Complexity and confidence scoring (AC: 7-8)
- [ ] Accuracy validation and flags (AC: 9-12)

## Dev Notes
- Measurement pipeline details: [../architecture/ml-processing-pipeline.md#measurement-service](../architecture/ml-processing-pipeline.md#measurement-service)
- Accuracy targets and validation: [../architecture/performance-scalability.md#ml-pipeline-optimization](../architecture/performance-scalability.md#ml-pipeline-optimization)
- Error handling and flags: [../architecture/error-handling-resilience.md#error-handling-strategy](../architecture/error-handling-resilience.md#error-handling-strategy)
- PRD traceability: [../prd/12-epic-and-story-structure.md#story-45-measurement-calculation-engine](../prd/12-epic-and-story-structure.md#story-45-measurement-calculation-engine)

## Dependencies
- 4.4 Mask R-CNN Roof Detection (polygons)
- 4.3 USGS LiDAR Integration (elevation data)

## Estimate
M (medium)

## Priority
P0

## Assumptions
- Pixel-to-feet conversion factor is derived from imagery metadata.
- LiDAR data available for pitch when possible; fallback flagged otherwise.
- Feature detection is basic and not exhaustive for MVP.

## Edge Cases
- Low-confidence detections leading to unstable polygons; apply smoothing.
- Missing LiDAR; ensure pitch tagged as Estimated with lowered confidence.
- Very complex roofs; cap computation time and report complexity score.

### Testing
- Unit: area/perimeter conversions; pitch/slope math with fixtures.
- Integration: end-to-end from polygons to metrics with and without LiDAR.
- Accuracy: validate ±3% target on known datasets.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | v1 | Initial draft created | Scrum Master |

## Dev Agent Record
- Agent Model Used: 
- Debug Log References: 
- Completion Notes List: 
- File List: 

## QA Results
- Pending