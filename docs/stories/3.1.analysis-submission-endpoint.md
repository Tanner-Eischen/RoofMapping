# Story 3.1: Analysis Submission Endpoint

## Status
Draft

## Story
**As a** frontend application
**I want** to submit an address for roof analysis
**So that** the ML processing can begin

## Acceptance Criteria
- [ ] API route created (`app/api/analyze/route.ts`)
- [ ] Request validation with Zod schema (address, lat, lng)
- [ ] Create analysis record in database (status: "queued")
- [ ] Return 202 Accepted with analysisId
- [ ] Error handling for invalid requests (400)
- [ ] Error handling for database failures (500)
- [ ] Logging of analysis submissions
- [ ] Rate limiting configured (100 requests/hour per IP)

## Tasks / Subtasks
- [ ] Implement `POST /api/analyze` route (AC: 1)
- [ ] Add Zod schema validation (AC: 2)
- [ ] Create DB record with status queued (AC: 3)
- [ ] Return 202 with `analysisId` (AC: 4)
- [ ] Add error handling paths (AC: 5-6)
- [ ] Log submissions (AC: 7)
- [ ] Configure rate limiting (AC: 8)

## Dev Notes
- API routes architecture: [../architecture/backend-architecture.md#api-routes-architecture](../architecture/backend-architecture.md#api-routes-architecture)
- Data layer (Prisma schema): [../architecture/data-layer.md#database-schema-prisma](../architecture/data-layer.md#database-schema-prisma)
- Shared types: [../architecture/data-layer.md#shared-typescript-types](../architecture/data-layer.md#shared-typescript-types)
- Error handling strategy: [../architecture/error-handling-resilience.md#error-handling-strategy](../architecture/error-handling-resilience.md#error-handling-strategy)
- PRD traceability: [../prd/12-epic-and-story-structure.md#story-31-analysis-submission-endpoint](../prd/12-epic-and-story-structure.md#story-31-analysis-submission-endpoint), [../prd/6-functional-requirements.md#p0-must-have](../prd/6-functional-requirements.md#p0-must-have)

## Dependencies
- 1.2 Database setup with Prisma
- 1.4 Environment configuration (rate limit secrets, DB URL)
- 3.2 SQS Queue Integration (if publishing message in this route)

## Estimate
M (medium)

## Priority
P0 (must-have per PRD functional requirements)

## Assumptions
- Database connection string configured in environment variables.
- Request payload includes address and coordinates from frontend.
- Basic rate limiting middleware available or implemented as part of this story.

## Edge Cases
- Invalid or missing fields in payload (400).
- Database write failure or timeout (500).
- Duplicate submission within short window (idempotency behavior decided).
- Rate limit exceeded response (429) with retry-after header.

### Testing
- Integration: `POST /api/analyze` happy path returns 202 with `analysisId`.
- Validation: invalid payload returns 400 with error details.
- Failure: simulated DB error returns 500 and logs structured error.
- Rate limit: exceeding threshold returns 429 and does not write.
- Logging: submission events recorded with request metadata and `analysisId`.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | v1 | Initial draft created | Scrum Master |

## Dev Agent Record
- Agent Model Used: 
- Debug Log References: 
- Completion Notes List: 
- File List: 

## QA Results
- Pending