# Story 4.4: Mask R-CNN Roof Detection

## Status
Draft

## Story
**As an** ML service
**I want** to detect roof boundaries using Mask R-CNN
**So that** I can extract roof polygons for measurement

## Acceptance Criteria
- [ ] Roof detector created (`ml-service/models/roof_detector.py`)
- [ ] Detectron2 Mask R-CNN initialized with pretrained weights
- [ ] Inference method implemented (input: image, output: detections)
- [ ] Mask-to-polygon conversion implemented
- [ ] Confidence score calculation
- [ ] Handle multiple detections (select largest)
- [ ] Model confidence threshold: 0.7
- [ ] Error handling for no detections

## Tasks / Subtasks
- [ ] Create detector and initialize weights (AC: 1-2)
- [ ] Implement inference and mask-to-polygon (AC: 3-4)
- [ ] Confidence scoring and selection (AC: 5-7)
- [ ] Error handling for no detections (AC: 8)

## Dev Notes
- Model pipeline stages and thresholds: [../architecture/ml-processing-pipeline.md#mask-r-cnn-roof-detection](../architecture/ml-processing-pipeline.md#mask-r-cnn-roof-detection)
- Measurement service integration: [../architecture/ml-processing-pipeline.md#measurement-service](../architecture/ml-processing-pipeline.md#measurement-service)
- Performance optimization: [../architecture/performance-scalability.md#ml-pipeline-optimization](../architecture/performance-scalability.md#ml-pipeline-optimization)
- PRD traceability: [../prd/12-epic-and-story-structure.md#story-44-mask-r-cnn-roof-detection](../prd/12-epic-and-story-structure.md#story-44-mask-r-cnn-roof-detection)

## Dependencies
- 4.2 Sentinel-2 Satellite Imagery Integration
- 4.1 Lambda Handler & Service Architecture

## Estimate
M (medium)

## Priority
P0

## Assumptions
- Pretrained weights available and compatible with Detectron2 version.
- Input images are preprocessed to expected resolution and format.
- Confidence threshold tuned to balance precision/recall.

## Edge Cases
- No detections; return clear error and suggest retry with alternate tile.
- Multiple overlapping detections; select largest by area.
- Model drift or performance regressions; monitor confidence metrics.

### Testing
- Unit: inference on sample images, mask-to-polygon conversion.
- Threshold tests: confidence threshold effects; selection of largest polygon.
- Performance: inference time within target bounds.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | v1 | Initial draft created | Scrum Master |

## Dev Agent Record
- Agent Model Used: 
- Debug Log References: 
- Completion Notes List: 
- File List: 

## QA Results
- Pending