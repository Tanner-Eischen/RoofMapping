# Story 4.7: Database Result Storage

## Status
Draft

## Story
**As an** ML service
**I want** to store analysis results in the database
**So that** the frontend can retrieve measurements

## Acceptance Criteria
- [ ] Database update logic in Lambda
- [ ] Update analysis status to "processing" when started
- [ ] Create measurements record with all calculated values
- [ ] Upload annotated images to S3
- [ ] Store S3 URLs in measurements
- [ ] Update analysis status to "completed" on success
- [ ] Update status to "needs_assist" if confidence <70%
- [ ] Update status to "failed" on errors
- [ ] Set completedAt timestamp

## Tasks / Subtasks
- [ ] Implement DB updates in Lambda (AC: 1-2)
- [ ] Create measurements and store S3 URLs (AC: 3-5)
- [ ] Update statuses for success/assist/failure (AC: 6-8)
- [ ] Set `completedAt` timestamp (AC: 9)

## Dev Notes
- Data schema & status lifecycle: [../architecture/data-layer.md#database-schema-prisma](../architecture/data-layer.md#database-schema-prisma)
- ML pipeline result handling: [../architecture/ml-processing-pipeline.md#measurement-service](../architecture/ml-processing-pipeline.md#measurement-service)
- Storage integration: [../architecture/external-integrations.md#aws-services](../architecture/external-integrations.md#aws-services)
- PRD traceability: [../prd/12-epic-and-story-structure.md#story-47-database-result-storage](../prd/12-epic-and-story-structure.md#story-47-database-result-storage)

## Dependencies
- 4.5 Measurement Calculation Engine
- 6.2 AWS Infrastructure Setup (S3)
- 1.2 Database Setup with Prisma

## Estimate
M (medium)

## Priority
P0

## Assumptions
- Annotated images are generated or available for upload.
- Database schema includes fields for measurements and asset URLs.
- Status transitions are atomic and reliable.

## Edge Cases
- S3 upload failure; retry and mark status accordingly.
- Partial write to DB; ensure transactions or rollback behavior.
- Low confidence analysis; status set to needs_assist consistently.

### Testing
- Integration: DB writes and S3 uploads with success/failure paths.
- Status lifecycle: processing â†’ completed/failed/needs_assist with timestamps.
- Consistency: measurement values align with calculated outputs.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | v1 | Initial draft created | Scrum Master |

## Dev Agent Record
- Agent Model Used: 
- Debug Log References: 
- Completion Notes List: 
- File List: 

## QA Results
- Pending