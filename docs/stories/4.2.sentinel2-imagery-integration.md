# Story 4.2: Sentinel-2 Satellite Imagery Integration

## Status
Draft

## Story
**As an** ML service
**I want** to fetch Sentinel-2 satellite imagery for a property location
**So that** I can detect roof boundaries

## Acceptance Criteria
- [ ] Sentinel client created (`ml-service/services/sentinel_client.py`)
- [ ] OAuth authentication with Sentinel Hub implemented
- [ ] Fetch imagery method with bbox calculation
- [ ] Filter for <20% cloud coverage
- [ ] RGB bands (B04, B03, B02) extraction
- [ ] Image resolution: 512x512 pixels
- [ ] Retry logic for API failures
- [ ] Error handling for no imagery available

## Tasks / Subtasks
- [ ] Implement client and OAuth auth (AC: 1-2)
- [ ] Fetch imagery with bbox and cloud filter (AC: 3-4)
- [ ] Extract RGB bands and resize (AC: 5-6)
- [ ] Add retry and error handling (AC: 7-8)

## Dev Notes
- External integrations: [../architecture/external-integrations.md#sentinel-hub-api](../architecture/external-integrations.md#sentinel-hub-api)
- ML pipeline: [../architecture/ml-processing-pipeline.md#external-data-clients](../architecture/ml-processing-pipeline.md#external-data-clients)
- Error handling patterns: [../architecture/error-handling-resilience.md#error-handling-strategy](../architecture/error-handling-resilience.md#error-handling-strategy)
- PRD traceability: [../prd/12-epic-and-story-structure.md#story-42-sentinel-2-satellite-imagery-integration](../prd/12-epic-and-story-structure.md#story-42-sentinel-2-satellite-imagery-integration)

## Dependencies
- 3.2 SQS Queue Integration (upstream event provides coordinates)
- 4.1 Lambda Handler initialized service clients

## Estimate
M (medium)

## Priority
P0

## Assumptions
- Sentinel Hub access credentials configured and valid.
- Bounding box calculation uses provided coordinates with standard buffer.
- Cloud coverage metadata available for filtering.

## Edge Cases
- No imagery within date range; graceful error and retry policy.
- High cloud coverage; fallback to alternate tiles or defer processing.
- OAuth token expiry mid-request; refresh handling.

### Testing
- Unit: bbox calculation, band selection, cloud coverage filter.
- Integration: mocked Sentinel API responses for success/failure paths.
- Resilience: retries and token refresh behaviors.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | v1 | Initial draft created | Scrum Master |

## Dev Agent Record
- Agent Model Used: 
- Debug Log References: 
- Completion Notes List: 
- File List: 

## QA Results
- Pending