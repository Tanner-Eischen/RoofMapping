# Story 4.2: Sentinel-2 Satellite Imagery Integration

## Status
Completed

## Story
**As an** ML service
**I want** to fetch Sentinel-2 satellite imagery for a property location
**So that** I can detect roof boundaries

## Acceptance Criteria
- [x] Sentinel client created (`src/ml/imagery/sentinel2.ts`)
- [x] Bearer authentication to external provider (config via env)
- [x] Fetch imagery with address parameter and 512x512 resolution
- [x] Filter for <20% cloud coverage
- [x] RGB bands (B04, B03, B02) exposed
- [x] Retry logic for API failures
- [x] Error handling for no imagery available

## Tasks / Subtasks
- [x] Implement client and auth using env Bearer (AC: 1-2)
- [x] Fetch imagery and cloud filter (AC: 3-4)
- [x] Expose RGB bands and 512x512 resolution (AC: 5-6)
- [x] Retry and error handling (AC: 7-8)

## Dev Notes
- External integrations: [../architecture/external-integrations.md#sentinel-hub-api](../architecture/external-integrations.md#sentinel-hub-api)
- ML pipeline: [../architecture/ml-processing-pipeline.md#external-data-clients](../architecture/ml-processing-pipeline.md#external-data-clients)
- Error handling patterns: [../architecture/error-handling-resilience.md#error-handling-strategy](../architecture/error-handling-resilience.md#error-handling-strategy)
- PRD traceability: [../prd/12-epic-and-story-structure.md#story-42-sentinel-2-satellite-imagery-integration](../prd/12-epic-and-story-structure.md#story-42-sentinel-2-satellite-imagery-integration)

## Dependencies
- 3.2 SQS Queue Integration (upstream event provides coordinates)
- 4.1 Lambda Handler initialized service clients

## Estimate
M (medium)

## Priority
P0

## Assumptions
- Sentinel Hub access credentials configured and valid.
- Bounding box calculation uses provided coordinates with standard buffer.
- Cloud coverage metadata available for filtering.

## Edge Cases
- No imagery within date range; graceful error and retry policy.
- High cloud coverage; fallback to alternate tiles or defer processing.
- OAuth token expiry mid-request; refresh handling.

### Testing
- Unit: bbox calculation, band selection, cloud coverage filter.
- Integration: mocked Sentinel API responses for success/failure paths.
- Resilience: retries and token refresh behaviors.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | v1 | Initial draft created | Scrum Master |

## Dev Agent Record
- Agent Model Used: 
- Debug Log References: 
- Completion Notes List: 
- File List: 

## QA Results
- Pending